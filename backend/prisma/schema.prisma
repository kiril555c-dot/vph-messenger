generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                   String          @id @default(auto()) @map("_id") @db.ObjectId
  email                String          @unique
  username             String          @unique
  password             String
  avatar               String?
  bio                  String?
  relationshipStatus   String?
  isOnline             Boolean         @default(false)
  lastSeen             DateTime        @default(now())
  notificationsEnabled Boolean         @default(true)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  messages             Message[]
  chatMembers          ChatMember[]
  messageStatus        MessageStatus[]
  contacts             Contact[]       @relation("UserContacts")
  contactOf            Contact[]       @relation("ContactOf")
}

model Contact {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  contactId String   @db.ObjectId
  createdAt DateTime @default(now())

  user      User     @relation("UserContacts", fields: [userId], references: [id])
  contact   User     @relation("ContactOf", fields: [contactId], references: [id])

  @@unique([userId, contactId])
}

model Chat {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String?
  isGroup   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages    Message[]
  chatMembers ChatMember[]
}

model ChatMember {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  chatId   String   @db.ObjectId
  userId   String   @db.ObjectId
  role     String   @default("MEMBER") // ADMIN, MEMBER
  joinedAt DateTime @default(now())

  chat Chat @relation(fields: [chatId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([chatId, userId])
}

model Message {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String?
  type      String   @default("TEXT") // TEXT, IMAGE, VIDEO, DOCUMENT, STICKER
  fileUrl   String?
  senderId  String   @db.ObjectId
  chatId    String   @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sender   User            @relation(fields: [senderId], references: [id])
  chat     Chat            @relation(fields: [chatId], references: [id])
  statuses MessageStatus[]
}

model MessageStatus {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  userId    String   @db.ObjectId
  status    String   @default("SENT") // SENT, DELIVERED, READ
  updatedAt DateTime @updatedAt

  message Message @relation(fields: [messageId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([messageId, userId])
}